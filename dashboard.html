<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إدارة كلمات المرور</title>

  <!-- خط عربي -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- QRCode JS -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f8f9fa;
    }
    h2 {
      font-weight: 700;
      color: #343a40;
    }
    .btn-primary {
      background-color: #0069d9;
      border-color: #0062cc;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #004085;
      border-color: #003768;
    }
    .btn-warning, .btn-danger, .btn-info {
      font-weight: 600;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    table thead {
      background-color: #343a40;
      color: white;
      font-weight: 700;
    }
    table tbody tr:hover {
      background-color: #e9ecef;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .copy-btn {
      cursor: pointer;
      color: #0d6efd;
      margin-left: 6px;
      font-size: 1rem;
    }
    .copy-btn:hover {
      color: #0a58ca;
    }
  </style>
</head>
<body>

<script>
  if (localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
</script>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2><i class="fa-solid fa-key"></i> إدارة كلمات المرور</h2>
    <button class="btn btn-danger" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</button>
  </div>

  <input type="text" id="searchInput" class="form-control mb-3" placeholder="🔍 بحث..." />

  <div class="mb-3 d-flex flex-wrap gap-2">
    <button id="editBtn" class="btn btn-warning" disabled onclick="editSelected()">
      <i class="fa-solid fa-pen-to-square"></i> تعديل
    </button>
    <button id="deleteBtn" class="btn btn-danger" disabled onclick="deleteSelected()">
      <i class="fa-solid fa-trash"></i> حذف
    </button>
    <button id="showQRBtn" class="btn btn-info" disabled onclick="showQR()">
      <i class="fa-solid fa-qrcode"></i> عرض QR
    </button>
    <button id="printBtn" class="btn btn-secondary" disabled onclick="printSelected()">
      <i class="fa-solid fa-print"></i> طباعة PDF
    </button>
    <button class="btn btn-primary ms-auto" onclick="openModal()">
      <i class="fa-solid fa-plus"></i> إضافة كلمة مرور
    </button>
  </div>

  <table class="table table-striped table-bordered text-center align-middle">
    <thead>
      <tr>
        <th style="width: 40px;"><input type="checkbox" id="selectAll" /></th>
        <th>الموقع</th>
        <th>اسم المستخدم</th>
        <th>كلمة المرور</th>
        <th>ملاحظات</th>
      </tr>
    </thead>
    <tbody id="passwordTable"></tbody>
  </table>
</div>

<!-- مودال الإدخال -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-key"></i> إضافة / تعديل كلمة مرور</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="recordId" />
        <input type="text" id="site" class="form-control mb-2" placeholder="الموقع" />
        <input type="text" id="username" class="form-control mb-2" placeholder="اسم المستخدم" />
        <input type="text" id="passwordValue" class="form-control mb-2" placeholder="كلمة المرور" />
        <textarea id="notes" class="form-control mb-2" placeholder="ملاحظات"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i> إلغاء</button>
        <button class="btn btn-success" onclick="savePassword()"><i class="fa-solid fa-floppy-disk"></i> حفظ</button>
      </div>
    </div>
  </div>
</div>

<!-- مودال عرض QR -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content text-center p-3">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-qrcode"></i> رمز QR</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <canvas id="qrCanvas"></canvas>
        <p class="mt-2" id="qrText" style="word-break: break-word;"></p>
      </div>
    </div>
  </div>
</div>

<!-- Toast إشعار النسخ -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">تم نسخ كلمة المرور!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="إغلاق"></button>
    </div>
  </div>
</div>

<script>
  // إعداد اتصال Supabase
  const supabaseUrl = "https://uxtdayylyjdxjvbaafvy.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4dGRheXlseWpkeGp2YmFhZnZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NDY4NzIsImV4cCI6MjA2ODAyMjg3Mn0.omGs5ay0iw9-00_t5es25d5F7LTXUFcRRI83XBKoalY";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let passwordsData = [];

  const editBtn = document.getElementById("editBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const showQRBtn = document.getElementById("showQRBtn");
  const printBtn = document.getElementById("printBtn");
  const selectAllCheckbox = document.getElementById("selectAll");
  const passwordTable = document.getElementById("passwordTable");

  // تحميل البيانات من Supabase
  async function loadPasswords() {
    const { data, error } = await supabase.from("passwords").select("*").order("id", { ascending: false });
    if (error) {
      alert("خطأ في جلب البيانات: " + error.message);
      return;
    }
    passwordsData = data;
    renderTable(data);
  }

  // عرض البيانات في الجدول
  function renderTable(data) {
    passwordTable.innerHTML = "";
    data.forEach(row => {
      passwordTable.innerHTML += `
        <tr>
          <td class="text-center"><input type="checkbox" class="row-checkbox" data-id="${row.id}" /></td>
          <td>${escapeHtml(row.site)}</td>
          <td>${escapeHtml(row.username)}</td>
          <td>
            ${escapeHtml(row.password)}
            <i class="fa-regular fa-copy copy-btn" title="نسخ كلمة المرور" onclick="copyPassword('${escapeHtml(row.password)}', this)"></i>
          </td>
          <td>${escapeHtml(row.notes || "")}</td>
        </tr>
      `;
    });
    attachCheckboxListeners();
    updateButtonsState();
  }

  // استمع لتغييرات مربعات الاختيار
  function attachCheckboxListeners() {
    const checkboxes = document.querySelectorAll(".row-checkbox");
    checkboxes.forEach(cb => cb.addEventListener("change", updateButtonsState));

    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;

    selectAllCheckbox.addEventListener("change", () => {
      const checkboxes = document.querySelectorAll(".row-checkbox");
      checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
      updateButtonsState();
    });
  }

  // تحديث حالة أزرار التحكم بناء على الاختيارات
  function updateButtonsState() {
    const selectedCheckboxes = document.querySelectorAll(".row-checkbox:checked");
    const count = selectedCheckboxes.length;

    editBtn.disabled = count !== 1;
    deleteBtn.disabled = count === 0;
    showQRBtn.disabled = count !== 1;
    printBtn.disabled = count !== 1;

    const allCheckboxes = document.querySelectorAll(".row-checkbox");
    selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
    selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
  }

  // فتح المودال لإضافة أو تعديل كلمة مرور
  function openModal() {
    document.getElementById("recordId").value = "";
    document.getElementById("site").value = "";
    document.getElementById("username").value = "";
    document.getElementById("passwordValue").value = "";
    document.getElementById("notes").value = "";
    new bootstrap.Modal(document.getElementById("passwordModal")).show();
  }

  // تعديل السجل المحدد
  function editSelected() {
    const selectedCheckbox = document.querySelector(".row-checkbox:checked");
    if (!selectedCheckbox) return;

    const id = Number(selectedCheckbox.getAttribute("data-id"));
    const record = passwordsData.find(p => p.id === id);
    if (!record) return;

    document.getElementById("recordId").value = record.id;
    document.getElementById("site").value = record.site;
    document.getElementById("username").value = record.username;
    document.getElementById("passwordValue").value = record.password;
    document.getElementById("notes").value = record.notes || "";
    new bootstrap.Modal(document.getElementById("passwordModal")).show();
  }

  // حذف السجلات المحددة
  async function deleteSelected() {
    const selectedCheckboxes = document.querySelectorAll(".row-checkbox:checked");
    if (selectedCheckboxes.length === 0) return;

    if (!confirm(`هل أنت متأكد من حذف ${selectedCheckboxes.length} سجل؟`)) return;

    const idsToDelete = Array.from(selectedCheckboxes).map(cb => Number(cb.getAttribute("data-id")));
    const { error } = await supabase.from("passwords").delete().in("id", idsToDelete);

    if (error) {
      alert("خطأ في الحذف: " + error.message);
    } else {
      loadPasswords();
    }
  }

  // حفظ كلمة المرور (إضافة أو تعديل)
  async function savePassword() {
    const id = document.getElementById("recordId").value;
    const site = document.getElementById("site").value.trim();
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("passwordValue").value.trim();
    const notes = document.getElementById("notes").value.trim();

    if (!site || !username || !password) {
      alert("الرجاء إدخال جميع الحقول المطلوبة");
      return;
    }

    if (id) {
      const { error } = await supabase.from("passwords").update({ site, username, password, notes }).eq("id", id);
      if (error) {
        alert("خطأ في التحديث: " + error.message);
        return;
      }
    } else {
      const { error } = await supabase.from("passwords").insert([{ site, username, password, notes }]);
      if (error) {
        alert("خطأ في الإضافة: " + error.message);
        return;
      }
    }

    bootstrap.Modal.getInstance(document.getElementById("passwordModal")).hide();
    loadPasswords();
  }

  // عرض رمز QR للسجل المختار
  function showQR() {
    const selectedCheckbox = document.querySelector(".row-checkbox:checked");
    if (!selectedCheckbox) return;

    const id = Number(selectedCheckbox.getAttribute("data-id"));
    const record = passwordsData.find(p => p.id === id);
    if (!record) return;

    const qrText =
      `موقع: ${record.site}؛ ` +
      `مستخدم: ${record.username}؛ ` +
      `كلمة مرور: ${record.password}؛ ` +
      `ملاحظات: ${record.notes || "لا توجد"}؛ ` +
      `تاريخ الإضافة: ${record.created_at ? new Date(record.created_at).toLocaleDateString("ar-EG") : "غير متوفر"}`;

    const canvas = document.getElementById("qrCanvas");
    QRCode.toCanvas(canvas, qrText, { width: 200, margin: 2 }, function (error) {
      if (error) {
        alert("حدث خطأ أثناء توليد رمز QR");
        console.error(error);
      } else {
        document.getElementById("qrText").textContent = qrText;
        new bootstrap.Modal(document.getElementById("qrModal")).show();
      }
    });
  }

  // نسخ كلمة المرور للحافظة مع إشعار
  function copyPassword(text, elem) {
    if (!navigator.clipboard) {
      alert("نسخ كلمة المرور غير مدعوم في هذا المتصفح");
      return;
    }
    navigator.clipboard.writeText(text).then(() => {
      const toastEl = document.getElementById('copyToast');
      const toast = new bootstrap.Toast(toastEl);
      toast.show();

      elem.style.color = '#198754';
      setTimeout(() => {
        elem.style.color = '#0d6efd';
      }, 1500);
    }).catch(() => {
      alert("حدث خطأ أثناء النسخ");
    });
  }

  // البحث في السجلات
  document.getElementById("searchInput").addEventListener("input", function () {
    const query = this.value.toLowerCase();
    if (!query) {
      renderTable(passwordsData);
      return;
    }
    const filtered = passwordsData.filter(row =>
      row.site.toLowerCase().includes(query) ||
      row.username.toLowerCase().includes(query) ||
      (row.notes && row.notes.toLowerCase().includes(query))
    );
    renderTable(filtered);
  });

  // تسجيل الخروج
  function logout() {
    localStorage.removeItem("loggedIn");
    window.location.href = "index.html";
  }

  // دالة هروب الأحرف الخاصة في النصوص لمنع مشاكل HTML
  function escapeHtml(text) {
    if (!text) return "";
    return text.replace(/[&<>"']/g, function (m) {
      switch (m) {
        case '&': return "&amp;";
        case '<': return "&lt;";
        case '>': return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#039;";
        default: return m;
      }
    });
  }

  // طباعة سجل مختار بصيغة PDF مع دعم الخط العربي
  async function printSelected() {
    const selectedCheckboxes = document.querySelectorAll(".row-checkbox:checked");
    if (selectedCheckboxes.length !== 1) {
      alert("يرجى اختيار سجل واحد فقط للطباعة.");
      return;
    }
    const id = Number(selectedCheckboxes[0].getAttribute("data-id"));
    const record = passwordsData.find(p => p.id === id);
    if (!record) return;

    // استخدم jsPDF بشكل صحيح من مكتبة umd
    const doc = new window.jspdf.jsPDF({
      unit: 'pt',
      format: 'a4',
    });

    // خط Cairo مضمن Base64 (مرفق سابقاً)
    const cairoFontBase64 = "AAEAAAASAQAABAAgR0RFRrRCsIIAAI9wAAAHEdQT1P9hL44AAAjGAAAAYkdQT1P4P2TJAAAIxAAABERHU1VCP2DpAAACVAAAADZHU1VCL" +
      "AxtRgAACBgAAABFPUy8yMrKGWQAAAewAAABiY21hcK73RIEAAALUAAACpmN2dCAvZ6UwAAAXoAAAAGZmcGdt9o3YDQAAFiQAAAOQaGRte" +
      "KdxABQAAAfAAAAG4aGVhZCluT1YAAAgYAAAANmhoZWEM4yc8AAIFQAAAAY2htdHgNT5oOAAAGtAAACd1sb2NhPrcb0wAABpgAAAIdbWF" +
      "4cAxYBHEAAAVkAAABRm5hbWWK8lXdAAAFgAAAAm5wb3N0P4skHAAABZwAAALecHJlcFe0/34AAAZEAAAAr3AAEAAABAAJwAAQAAAQAE" +
      "AOAAGAAAAAA";

    // تسجيل الخط العربي
    doc.addFileToVFS("Cairo-Regular.ttf", cairoFontBase64);
    doc.addFont("Cairo-Regular.ttf", "Cairo", "normal");
    doc.setFont("Cairo");

    // إعدادات النص والكتابة من اليمين إلى اليسار
    const margin = 40;
    let y = 80;
    const lineHeight = 25;
    const pageWidth = doc.internal.pageSize.getWidth();

    doc.setFontSize(18);
    doc.text("سجل كلمة المرور", pageWidth - margin, y, { align: "right" });
    y += 40;

    doc.setFontSize(14);
    doc.text(`الموقع: ${record.site}`, pageWidth - margin, y, { align: "right" });
    y += lineHeight;
    doc.text(`اسم المستخدم: ${record.username}`, pageWidth - margin, y, { align: "right" });
    y += lineHeight;
    doc.text(`كلمة المرور: ${record.password}`, pageWidth - margin, y, { align: "right" });
    y += lineHeight;
    doc.text(`ملاحظات: ${record.notes || "-"}`, pageWidth - margin, y, { align: "right" });
    y += lineHeight;

    if (record.created_at) {
      const dateStr = new Date(record.created_at).toLocaleString("ar-EG");
      doc.text(`تاريخ الإضافة: ${dateStr}`, pageWidth - margin, y, { align: "right" });
    }

    doc.save(`Password_Record_${record.id}.pdf`);
  }

  // تحميل البيانات أول مرة
  loadPasswords();
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
